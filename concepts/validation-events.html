<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Validation Events</title>

        <style>
            body {
                margin: 0;
                padding: 0;
                font-family: system-ui, -apple-system, sans-serif;
            }

            .container {
                margin: 2rem;
            }

            .title {
                font-size: 1.125rem;
                font-weight: bold;
                margin-bottom: 1rem;
            }

            .example-title {
                font-size: 0.95rem;
                font-weight: 600;
                margin-top: 2rem;
                margin-bottom: 0.75rem;
                color: #18181b;
            }

            .example-title:first-of-type {
                margin-top: 0;
            }

            .example-desc {
                font-size: 0.85rem;
                line-height: 1.6;
                color: #52525b;
                margin-bottom: 1rem;
            }

            .columns {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
            }

            .column-header {
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: #71717a;
                margin-bottom: 0.75rem;
            }

            .source-wrapper {
                position: relative;
            }

            .copy-btn {
                position: absolute;
                top: 0.5rem;
                right: 0.5rem;
                background: #313244;
                border: 1px solid #45475a;
                color: #cdd6f4;
                border-radius: 6px;
                padding: 4px 8px;
                font-size: 0.7rem;
                font-family: inherit;
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .copy-btn:hover {
                background: #45475a;
            }

            .source-code {
                background: #1e1e2e;
                color: #cdd6f4;
                border-radius: 8px;
                padding: 1rem 1.25rem;
                font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
                font-size: 0.8rem;
                line-height: 1.7;
                overflow-x: auto;
                white-space: pre-wrap;
                word-break: break-all;
                margin: 0;
            }

            .source-code .tag { color: #89b4fa; }
            .source-code .attr { color: #f9e2af; }
            .source-code .val { color: #a6e3a1; }
            .source-code .comment { color: #6c7086; font-style: italic; }
            .source-code .kw { color: #cba6f7; }
            .source-code .fn { color: #89b4fa; }
            .source-code .str { color: #a6e3a1; }
            .source-code .prop { color: #f9e2af; }
            .source-code .num { color: #fab387; }

            .event-log {
                background: #1e1e2e;
                border-radius: 8px;
                padding: 1rem 1.25rem;
                font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
                font-size: 0.8rem;
                line-height: 1.7;
                min-height: 120px;
                max-height: 260px;
                overflow-y: auto;
                color: #6c7086;
                margin-top: 0.75rem;
            }

            .event-log .log-entry {
                padding: 2px 0;
            }

            .event-log .valid {
                color: #a6e3a1;
            }

            .event-log .invalid {
                color: #f38ba8;
            }

            .event-log .issues-toggle {
                background: none;
                border: none;
                color: #6c7086;
                font-family: inherit;
                font-size: 0.75rem;
                cursor: pointer;
                padding: 0 0 0 1rem;
                text-decoration: underline;
                text-decoration-style: dotted;
            }

            .event-log .issues-toggle:hover {
                color: #cdd6f4;
            }

            .event-log .issues-detail {
                display: none;
                padding: 0.25rem 0 0.25rem 1.5rem;
                color: #a6adc8;
                font-size: 0.75rem;
            }

            .event-log .issues-detail.open {
                display: block;
            }

            .log-label {
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: #71717a;
                margin-top: 0.75rem;
                margin-bottom: 0;
            }

            @media (max-width: 700px) {
                .columns {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1 class="title">Validation Events</h1>

            <h2 class="example-title">Listening for <code>tiro-validate</code></h2>
            <p class="example-desc">
                The <code>&lt;tiro-form-filler&gt;</code> element emits a <code>tiro-validate</code> CustomEvent after every change.
                The event's <code>detail</code> contains <code>isValid</code> (boolean) and <code>operationOutcome</code> (a FHIR OperationOutcome resource listing any issues).
            </p>
            <div class="columns">
                <div>
                    <div class="column-header">Preview</div>
                    <tiro-form-filler id="validation-form">
                        <script type="application/fhir+json" slot="questionnaire">
{
    "resourceType": "Questionnaire",
    "status": "active",
    "item": [
        {
            "linkId": "group-1",
            "type": "group",
            "text": "Patient Information",
            "extension": [
                {
                    "url": "http://hl7.org/fhir/StructureDefinition/questionnaire-itemControl",
                    "valueCodeableConcept": {
                        "text": "block",
                        "coding": [{ "system": "http://fhir.tiro.health/CodeSystem/tiro-questionnaire-item-control", "code": "block" }]
                    }
                }
            ],
            "item": [
                {
                    "linkId": "patient-name",
                    "type": "string",
                    "text": "Patient name",
                    "required": true
                },
                {
                    "linkId": "patient-age",
                    "type": "decimal",
                    "text": "Age"
                }
            ]
        }
    ]
}
                        </script>
                    </tiro-form-filler>

                    <div class="log-label">Event Log</div>
                    <div class="event-log" id="event-log">
                        <span style="color: #6c7086; font-style: italic;">Waiting for validation events&hellip;</span>
                    </div>
                </div>
                <div>
                    <div class="column-header">Source</div>
                    <div class="source-wrapper">
                        <button class="copy-btn" onclick="copySource(this)">Copy</button>
                        <pre class="source-code"><span class="comment">&lt;!-- A form with a required field --&gt;</span>
<span class="tag">&lt;tiro-form-filler</span> <span class="attr">id</span>=<span class="val">"my-form"</span><span class="tag">&gt;</span>
  <span class="tag">&lt;script</span> <span class="attr">type</span>=<span class="val">"application/fhir+json"</span>
          <span class="attr">slot</span>=<span class="val">"questionnaire"</span><span class="tag">&gt;</span>
  {
    <span class="attr">"resourceType"</span>: <span class="val">"Questionnaire"</span>,
    <span class="attr">"status"</span>: <span class="val">"active"</span>,
    <span class="attr">"item"</span>: [{
      <span class="attr">"linkId"</span>: <span class="val">"name"</span>,
      <span class="attr">"type"</span>: <span class="val">"string"</span>,
      <span class="attr">"text"</span>: <span class="val">"Patient name"</span>,
      <span class="attr">"required"</span>: <span class="num">true</span>
    }]
  }
  <span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/tiro-form-filler&gt;</span>

<span class="comment">&lt;!-- Listen for validation events --&gt;</span>
<span class="tag">&lt;script&gt;</span>
  <span class="kw">const</span> form = document.<span class="fn">getElementById</span>(<span class="str">"my-form"</span>);

  form.<span class="fn">addEventListener</span>(<span class="str">"tiro-validate"</span>, (e) =&gt; {
    <span class="kw">const</span> { <span class="prop">isValid</span>, <span class="prop">operationOutcome</span> } = e.detail;

    <span class="kw">if</span> (isValid) {
      console.<span class="fn">log</span>(<span class="str">"Form is valid"</span>);
    } <span class="kw">else</span> {
      <span class="kw">const</span> issues = operationOutcome.<span class="prop">issue</span>;
      console.<span class="fn">log</span>(<span class="str">"Invalid:"</span>, issues.<span class="prop">length</span>, <span class="str">"issue(s)"</span>);
      issues.<span class="fn">forEach</span>((i) =&gt;
        console.<span class="fn">log</span>(<span class="str">`  [${i.severity}] ${i.diagnostics}`</span>)
      );
    }
  });
<span class="tag">&lt;/script&gt;</span></pre>
                    </div>
                </div>
            </div>
        </div><!-- .container -->

        <script>
            var log = document.getElementById('event-log');
            var firstEvent = true;

            document.getElementById('validation-form').addEventListener('tiro-validate', function(e) {
                if (firstEvent) {
                    log.innerHTML = '';
                    firstEvent = false;
                }

                var detail = e.detail;
                var entry = document.createElement('div');
                entry.className = 'log-entry';

                if (detail.isValid) {
                    entry.innerHTML = '<span class="valid">\u2713 Valid</span>';
                } else {
                    var issues = (detail.operationOutcome && detail.operationOutcome.issue) || [];
                    var id = 'issues-' + Date.now();
                    entry.innerHTML = '<span class="invalid">\u2717 Invalid \u2014 ' + issues.length + ' issue(s)</span>'
                        + '<button class="issues-toggle" onclick="toggleIssues(\'' + id + '\')">details</button>'
                        + '<div class="issues-detail" id="' + id + '">'
                        + issues.map(function(issue) {
                            return '<div>[' + (issue.severity || 'error') + '] ' + (issue.diagnostics || issue.details?.text || 'Unknown issue') + '</div>';
                        }).join('')
                        + '</div>';
                }

                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            });

            function toggleIssues(id) {
                var el = document.getElementById(id);
                if (el) el.classList.toggle('open');
            }

            function copySource(btn) {
                var text = '<tiro-form-filler id="my-form">\n'
                    + '  <script type="application/fhir+json" slot="questionnaire">\n'
                    + '  {\n'
                    + '    "resourceType": "Questionnaire",\n'
                    + '    "status": "active",\n'
                    + '    "item": [{\n'
                    + '      "linkId": "name",\n'
                    + '      "type": "string",\n'
                    + '      "text": "Patient name",\n'
                    + '      "required": true\n'
                    + '    }]\n'
                    + '  }\n'
                    + '  <\/script>\n'
                    + '<\/tiro-form-filler>\n'
                    + '\n'
                    + '<script>\n'
                    + '  const form = document.getElementById("my-form");\n'
                    + '\n'
                    + '  form.addEventListener("tiro-validate", (e) => {\n'
                    + '    const { isValid, operationOutcome } = e.detail;\n'
                    + '\n'
                    + '    if (isValid) {\n'
                    + '      console.log("Form is valid");\n'
                    + '    } else {\n'
                    + '      const issues = operationOutcome.issue;\n'
                    + '      console.log("Invalid:", issues.length, "issue(s)");\n'
                    + '      issues.forEach((i) =>\n'
                    + '        console.log(`  [${i.severity}] ${i.diagnostics}`)\n'
                    + '      );\n'
                    + '    }\n'
                    + '  });\n'
                    + '<\/script>';
                navigator.clipboard.writeText(text).then(function() {
                    btn.textContent = 'Copied!';
                    setTimeout(function() { btn.textContent = 'Copy'; }, 1500);
                });
            }
        </script>

        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.production.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        ></script>
        <script src="https://cdn.tiro.health/sdk/v0.2.1/tiro-web-sdk.iife.js"></script>
    </body>
</html>
